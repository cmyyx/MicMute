name: Build MicMute

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ”§ è®¾ç½® MSBuild
      uses: microsoft/setup-msbuild@v1.3
      
    - name: ðŸ”§ è®¾ç½® NuGet
      uses: NuGet/setup-nuget@v1
      
    - name: ðŸ“¦ è¿˜åŽŸ NuGet åŒ…
      run: nuget restore MicMute.sln
      
    - name: ðŸ—ï¸ æž„å»º Debug ç‰ˆæœ¬
      run: msbuild MicMute.sln /p:Configuration=Debug /p:Platform="Any CPU" /v:detailed
      
    - name: ðŸ—ï¸ æž„å»º Release ç‰ˆæœ¬
      run: msbuild MicMute.sln /p:Configuration=Release /p:Platform="Any CPU" /v:detailed
      
    - name: ðŸ“‹ åˆ—å‡ºæž„å»ºè¾“å‡º
      run: |
        echo "=== Debug è¾“å‡º ==="
        dir bin\Debug
        echo ""
        echo "=== Release è¾“å‡º ==="
        dir bin\Release
      shell: cmd
      
    - name: ðŸ“¦ æ‰“åŒ… Debug ç‰ˆæœ¬
      run: |
        mkdir artifacts\debug
        copy bin\Debug\MicMute.exe artifacts\debug\
        copy bin\Debug\*.dll artifacts\debug\ 2>nul || echo "No DLLs to copy"
        copy bin\Debug\*.config artifacts\debug\ 2>nul || echo "No config files"
      shell: cmd
      continue-on-error: true
      
    - name: ðŸ“¦ æ‰“åŒ… Release ç‰ˆæœ¬
      run: |
        mkdir artifacts\release
        copy bin\Release\MicMute.exe artifacts\release\
        copy bin\Release\*.dll artifacts\release\ 2>nul || echo "No DLLs to copy"
        copy bin\Release\*.config artifacts\release\ 2>nul || echo "No config files"
      shell: cmd
      continue-on-error: true
      
    - name: ðŸ“¤ ä¸Šä¼  Debug æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: MicMute-Debug
        path: artifacts/debug/
        retention-days: 30
        
    - name: ðŸ“¤ ä¸Šä¼  Release æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: MicMute-Release
        path: artifacts/release/
        retention-days: 90
        
    - name: ðŸ“Š æž„å»ºæ‘˜è¦
      run: |
        echo "## ðŸŽ‰ æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug ç‰ˆæœ¬**: MicMute-Debug" >> $GITHUB_STEP_SUMMARY
        echo "- **Release ç‰ˆæœ¬**: MicMute-Release" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
        echo "1. ç‚¹å‡»ä¸Šæ–¹ 'Summary' æ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
        echo "2. åœ¨ 'Artifacts' éƒ¨åˆ†æ‰¾åˆ°æž„å»ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "3. ç‚¹å‡»ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â„¹ï¸ æ–‡ä»¶ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        if (Test-Path "bin\Release\MicMute.exe") {
          $fileInfo = Get-Item "bin\Release\MicMute.exe"
          echo "- **æ–‡ä»¶å¤§å°**: $([math]::Round($fileInfo.Length / 1MB, 2)) MB" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $GITHUB_STEP_SUMMARY
        }
      shell: pwsh
