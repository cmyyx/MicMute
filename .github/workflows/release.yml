name: Release Build

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  release:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ”§ è®¾ç½® MSBuild
      uses: microsoft/setup-msbuild@v1.3
      
    - name: ðŸ”§ è®¾ç½® NuGet
      uses: NuGet/setup-nuget@v1
      
    - name: ðŸ“¦ è¿˜åŽŸ NuGet åŒ…
      run: nuget restore MicMute.sln
      
    - name: ðŸ—ï¸ æž„å»º Release ç‰ˆæœ¬
      run: msbuild MicMute.sln /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=bin\Release\ /v:detailed
      
    - name: ðŸ“‹ éªŒè¯æž„å»ºè¾“å‡º
      run: |
        echo "=== æž„å»ºè¾“å‡ºæ–‡ä»¶ ==="
        dir bin\Release
        echo ""
        if exist "bin\Release\MicMute.exe" (
          echo âœ“ MicMute.exe æž„å»ºæˆåŠŸ
        ) else (
          echo âœ— MicMute.exe æœªæ‰¾åˆ°
          exit 1
        )
      shell: cmd
      
    - name: ðŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir release-package
        copy bin\Release\MicMute.exe release-package\
        copy bin\Release\*.config release-package\ 2>nul || echo "No config files"
        
        REM åˆ›å»º README
        echo MicMute - éº¦å…‹é£Žé™éŸ³æé†’å·¥å…· > release-package\README.txt
        echo. >> release-package\README.txt
        echo ä½¿ç”¨è¯´æ˜Žï¼š >> release-package\README.txt
        echo 1. åŒå‡»è¿è¡Œ MicMute.exe >> release-package\README.txt
        echo 2. ç¨‹åºä¼šæœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜ >> release-package\README.txt
        echo 3. å³é”®æ‰˜ç›˜å›¾æ ‡è¿›è¡Œè®¾ç½® >> release-package\README.txt
        echo. >> release-package\README.txt
        echo åŠŸèƒ½ç‰¹æ€§ï¼š >> release-package\README.txt
        echo - éº¦å…‹é£Žé™éŸ³/å–æ¶ˆé™éŸ³å¿«æ·é”® >> release-package\README.txt
        echo - é™éŸ³æ—¶æ˜¾ç¤ºæ‚¬æµ®çª—æé†’ >> release-package\README.txt
        echo - å¯è‡ªå®šä¹‰æ‚¬æµ®çª—ä½ç½® >> release-package\README.txt
        echo - æ”¯æŒé€‰æ‹©ç‰¹å®šéº¦å…‹é£Žè®¾å¤‡ >> release-package\README.txt
        
        echo æž„å»ºå®Œæˆï¼
        dir release-package
      shell: cmd
      
    - name: ðŸ“¦ åˆ›å»º ZIP åŽ‹ç¼©åŒ…
      run: |
        Compress-Archive -Path release-package\* -DestinationPath MicMute-Release.zip
        echo "åŽ‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ"
        Get-Item MicMute-Release.zip | Format-List
      shell: pwsh
      
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: MicMute-Release-Package
        path: release-package/
        retention-days: 90
        
    - name: ðŸ“¤ ä¸Šä¼  ZIP åŽ‹ç¼©åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: MicMute-Release-ZIP
        path: MicMute-Release.zip
        retention-days: 90
        
    - name: ðŸŽ‰ åˆ›å»º GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          MicMute-Release.zip
          release-package/MicMute.exe
        body: |
          ## ðŸŽ‰ MicMute å‘å¸ƒç‰ˆæœ¬
          
          ### ðŸ“¥ ä¸‹è½½
          - **å®Œæ•´åŒ…**: MicMute-Release.zipï¼ˆæŽ¨èï¼‰
          - **å•æ–‡ä»¶**: MicMute.exe
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - âœ… éº¦å…‹é£Žé™éŸ³/å–æ¶ˆé™éŸ³å¿«æ·é”®
          - âœ… é™éŸ³æ—¶æ˜¾ç¤ºæ‚¬æµ®çª—æé†’
          - âœ… å¯è‡ªå®šä¹‰æ‚¬æµ®çª—ä½ç½®ï¼ˆä¸å¯ç‚¹å‡»ç©¿é€ï¼‰
          - âœ… æ”¯æŒé€‰æ‹©ç‰¹å®šéº¦å…‹é£Žè®¾å¤‡
          - âœ… éŸ³é¢‘æç¤ºéŸ³æ•ˆ
          
          ### ðŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `MicMute-Release.zip` å¹¶è§£åŽ‹
          2. åŒå‡»è¿è¡Œ `MicMute.exe`
          3. ç¨‹åºä¼šæœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜ï¼ˆä»»åŠ¡æ å³ä¸‹è§’ï¼‰
          4. å³é”®ç‚¹å‡»æ‰˜ç›˜å›¾æ ‡è¿›è¡Œè®¾ç½®
          
          ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 7 æˆ–æ›´é«˜ç‰ˆæœ¬
          - .NET Framework 4.5.2 æˆ–æ›´é«˜ï¼ˆWindows 10/11 å·²é¢„è£…ï¼‰
          
          ### ðŸ”§ è®¾ç½®è¯´æ˜Ž
          - **é€‰æ‹©éº¦å…‹é£Ž**: å³é”®æ‰˜ç›˜å›¾æ ‡ â†’ Select mic
          - **è®¾ç½®å¿«æ·é”®**: å³é”®æ‰˜ç›˜å›¾æ ‡ â†’ Hotkey
          - **æ‚¬æµ®çª—ä½ç½®**: åœ¨ Hotkey è®¾ç½®ä¸­è°ƒæ•´åæ ‡å¹¶é¢„è§ˆ
          
          ---
          
          æž„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“Š æž„å»ºæ‘˜è¦
      run: |
        echo "## ðŸŽ‰ Release æž„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Œæ•´åŒ…**: MicMute-Release-Package" >> $GITHUB_STEP_SUMMARY
        echo "- **ZIP åŽ‹ç¼©åŒ…**: MicMute-Release-ZIP" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if (Test-Path "bin\Release\MicMute.exe") {
          $fileInfo = Get-Item "bin\Release\MicMute.exe"
          echo "### â„¹ï¸ æ–‡ä»¶ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶å¤§å°**: $([math]::Round($fileInfo.Length / 1MB, 2)) MB" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶è·¯å¾„**: bin\Release\MicMute.exe" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $GITHUB_STEP_SUMMARY
        }
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
        echo "1. ç‚¹å‡»ä¸Šæ–¹ 'Summary' æ ‡ç­¾" >> $GITHUB_STEP_SUMMARY
        echo "2. åœ¨ 'Artifacts' éƒ¨åˆ†æ‰¾åˆ°æž„å»ºæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "3. ç‚¹å‡»ä¸‹è½½ ZIP æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        
        if ("${{ github.ref }}" -like "refs/tags/*") {
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Release å·²åˆ›å»º" >> $GITHUB_STEP_SUMMARY
          echo "å‰å¾€ [Releases é¡µé¢](https://github.com/${{ github.repository }}/releases) æŸ¥çœ‹å’Œä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        }
      shell: pwsh
